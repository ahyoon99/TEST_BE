pipeline {
    agent any

    tools {
        maven 'maven' // ğŸ”§ Jenkinsì— ë“±ë¡ëœ Maven ì´ë¦„
    }

    environment {
        DEV_BACK_IP = '43.201.148.15' // ğŸ”§ EC2 í¼ë¸”ë¦­ IP
        DOCKER_IMAGE = 'ahyoon99/questory-be' // ğŸ”§ Docker Hub ì €ì¥ì†Œ : 'your-dockerhub-id/questory-be'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Git Checkout'
                git branch: 'dev', // ğŸ”§ ê¸°ëŠ¥ ë¸Œëœì¹˜
                    credentialsId: 'jenkins-github-test', // ğŸ”§ GitHub ì¸ì¦ ì •ë³´ : your-credential-id
                    url: 'https://github.com/TEST/BE.git' // ğŸ”§ GitHub URL
            }
        }

        stage('Test') {
            steps {
                echo 'ğŸ§ª Run Tests'
                dir('questory/BE') {
                    sh 'mvn clean test'
                }
            }
        }

        stage('Build Jar') {
            steps {
                echo 'ğŸ—ï¸ Build Jar'
                dir('questory/BE') {
                    sh 'mvn package -DskipTests'
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'ğŸ³ Docker Image Build'
                dir('questory/BE') {
                    sh "docker build -t ${DOCKER_IMAGE}:latest ."
                }
            }
        }

        stage('Push to DockerHub') {
            steps {
                echo 'ğŸ“¦ DockerHub Push'
                withCredentials([usernamePassword(credentialsId: 'dockerhub-cred', usernameVariable: 'DOCKERHUB_USER', passwordVariable: 'DOCKERHUB_PASS')]) {
                    sh """
                        echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
                        docker push ${DOCKER_IMAGE}:latest
                    """
                }
            }
        }

        stage('Deploy on EC2') {
            steps {
                script {
                    withCredentials([sshUserPrivateKey(credentialsId: 'pem-key', keyFileVariable: 'my_private_key_file')]) {
                        echo 'ğŸš€ EC2 Deploy'
                        sh """
                            ssh -o StrictHostKeyChecking=no -i ${my_private_key_file} ubuntu@${DEV_BACK_IP} '
                              docker pull ${DOCKER_IMAGE}:latest &&
                              docker stop questory || true &&
                              docker rm questory || true &&
                              docker run -d --name questory -p 8080:8080 ${DOCKER_IMAGE}:latest
                            '
                        """
                    }
